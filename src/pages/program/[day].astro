---
import Layout from "../../layouts/Layout.astro";
import type { TimeRecord } from "../../models/airtable";
import { getData } from "../../util/fetchUtil";
import { groupBy } from "../../util/groupUtil";

import format from "date-fns/format/index.js";
import en from "date-fns/locale/en-GB/index.js";

import { formatDate } from "../../util/localeUtil";

import { Icon } from "astro-icon";

import {
  applicableRooms,
  applicableStartTimes,
  firstLetterUppercase,
} from "../../util/util";

import ProgramListGridGap from "../../components/ProgramListGridGap.astro";
import DayHeader from "../../components/DayHeader.astro";
import ProgramListFlex from "../../components/ProgramListFlex.astro";

export interface Props {
  date: string;
  relevantSlots: TimeRecord[];
  previousDate?: string;
  nextDate?: string;
  startTimes: string[];
  rooms: string[];
}

export async function getStaticPaths() {
  const data = await getData();

  const dayData = groupBy(data, (v) => v.fields.date);
  const dayKeys = Object.keys(dayData);

  return dayKeys.map((date, index) => {
    const timeSlots = dayData[date];
    return {
      params: {
        day: format(new Date(date), "EEEE", { locale: en }).toLowerCase(),
      },
      props: {
        date: date,
        relevantSlots: timeSlots,
        previousDate: dayKeys[index - 1],
        nextDate: dayKeys[index + 1],
        startTimes: applicableStartTimes(timeSlots),
        rooms: applicableRooms(timeSlots),
      },
    };
  });
}

const { relevantSlots, date, previousDate, nextDate, startTimes, rooms } =
  Astro.props;
---

<Layout
  title={firstLetterUppercase(formatDate(date, "EEEE")) +
    " - Knowit Fagseminar Roma"}
  currentPage="Program"
>
  <main class="m-auto min-h-full">
    <div class="pb-4 md:pt-5">
      <DayHeader date={date} nextDate={nextDate} previousDate={previousDate} />
    </div>

    <div class="">
      <ProgramListFlex relevantSlots={relevantSlots} />
    </div>
    <div class="md:mt-2">
      <DayHeader date={date} nextDate={nextDate} previousDate={previousDate} />
    </div>
  </main>
</Layout>

<style>

</style>
