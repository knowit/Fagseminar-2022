---
import Layout from "../../layouts/Layout.astro";
import type { TimeRecord } from "../../models/airtable";
import { getData } from "../../util/fetchUtil";
import { groupBy } from "../../util/groupUtil";

import format from "date-fns/format/index.js";
import en from "date-fns/locale/en-GB/index.js";

import { formatDate } from "../../util/localeUtil";

import { Icon } from "astro-icon";

import { applicableRooms, applicableStartTimes } from "../../util/util";

import ProgramListGridGap from "../../components/ProgramListGridGap.astro";

export interface Props {
  date: string;
  relevantSlots: TimeRecord[];
  previousDate?: string;
  nextDate?: string;
  startTimes: string[];
  rooms: string[];
}

export async function getStaticPaths() {
  const data = await getData();

  const dayData = groupBy(data, (v) => v.fields.date);
  const dayKeys = Object.keys(dayData);

  return dayKeys.map((date, index) => {
    const timeSlots = dayData[date];
    return {
      params: {
        day: format(new Date(date), "EEEE", { locale: en }).toLowerCase(),
      },
      props: {
        date: date,
        relevantSlots: timeSlots,
        previousDate: dayKeys[index - 1],
        nextDate: dayKeys[index + 1],
        startTimes: applicableStartTimes(timeSlots),
        rooms: applicableRooms(timeSlots),
      },
    };
  });
}

function firstLetterUppercase(str: string) {
  return str.charAt(0).toUpperCase() + str.slice(1);
}

const { relevantSlots, date, previousDate, nextDate, startTimes, rooms } =
  Astro.props;
---

<Layout
  title={firstLetterUppercase(formatDate(date, "EEEE")) +
    " - Knowit Fagseminar Roma"}
  currentPage="Program"
>
  <main class="min-h-full w-11/12 m-auto">
    <section
      class="flex flex-wrap gap-x-7 gap-y-4 justify-center items-center w-full pb-10"
    >
      <div class="flex flex-row items-center w-fit sticky top-50">
        <a
          class={`caret  ${previousDate != null ? "" : "pointer-events-none"} `}
          href={previousDate != null
            ? `/Fagseminar-2022/program/${format(
                new Date(previousDate),
                "EEEE",
                {
                  locale: en,
                }
              ).toLowerCase()}`
            : ""}
        >
          <Icon
            pack="ant-design"
            name="caret-left-filled"
            class={previousDate != null ? "" : "hidden"}
          />
        </a>
        <h2
          class="text-center font-bold block w-30 text-2xl sm:text-4xl sm:w-60"
        >
          {firstLetterUppercase(formatDate(date, "EEEE d"))}
        </h2>
        <a
          class={`caret  ${nextDate != null ? "" : "pointer-events-none"}`}
          href={nextDate != null
            ? `/Fagseminar-2022/program/${format(new Date(nextDate), "EEEE", {
                locale: en,
              }).toLowerCase()}`
            : ""}
        >
          <Icon
            pack="ant-design"
            name="caret-right-filled"
            class={nextDate != null ? "" : "hidden"}
          />
        </a>
      </div>
      <p class="h-fit max-w-prose">
        Knowit Objectnet loren isun sit amet, loren isun sit ametloren isun sit
        ametloren isun sit ametloren isun sit ametlor oren isun sit ametloren
        isun sit ametloren isun.
      </p>
    </section>

    <ProgramListGridGap
      relevantSlots={relevantSlots}
      rooms={rooms}
      startTimes={startTimes}
    />
  </main>
</Layout>

<style>
  .caret {
    @apply w-10;
  }
</style>
